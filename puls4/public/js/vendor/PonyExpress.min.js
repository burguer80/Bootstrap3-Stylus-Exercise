/*!Wed Jun 05 2013 11:52:43 */
Class("PonyExpress").includes(CustomEventSupport)({capitalise:function(a){return a.charAt(0).toUpperCase()+a.slice(1)},prototype:{_io:null,init:function(a){console.log("connection to:",a.io);var b=this;this._io=io.connect(a.io),this._io.on("connect",function(){b.connected=!0,b.dispatch("connect")})}}}),Class(PonyExpress,"Plug").includes(CustomEventSupport)({prototype:{namespace:"",init:function(a){if(!window.ponyExpress)throw"Create a PonyExpress before a PonyExpress Model";if(!a.name)throw"All ponyExpress models require a name";a.events=a.events||[];for(var b in a)a.hasOwnProperty(b)&&(this[b]=a[b]);this._bindCrud()},_bindCrud:function(){var a=this;window.ponyExpress._io.on(this.name+"::create",function(b){a.onCreate(b)}),window.ponyExpress._io.on(this.name+"::delete",function(b){a.onDelete(b)}),window.ponyExpress._io.on(this.name+"::update",function(b){a.onUpdate(b)}),this.events.forEach(function(b){window.ponyExpress._io.on(a.name+"::"+b,function(c){a["on"+PonyExpress.capitalise(b)](c),a.dispatch(b,c)})})},onCreate:function(a){if(!a.id)throw"PonyExpress Items need id";this.dispatch("create",a)},onDelete:function(a){if(!a.id)throw"PonyExpress Items need id";this.dispatch("delete",a)},onUpdate:function(a){if(!a.id)throw"PonyExpress Items need id";this.dispatch("update",a)}}}),Class(PonyExpress,"BackbonePlug").inherits(PonyExpress.Plug)({prototype:{namespace:"",events:[],init:function(a){a.name=a.name||a.collection.name,a.channel&&ponyExpress._io.emit("channel",a.channel),PonyExpress.Plug.prototype.init.call(this,a)},onCreate:function(a){if(!a.id)throw"PonyExpress Items need id";this.collection.add(a),this.dispatch("create",a)},onDelete:function(a){if(!a.id)throw"PonyExpress Items need id";var b=this.collection.find(function(b){return b.get("id")===a.id});b&&(b.trigger("destroy",b,b.collection),this.dispatch("update",a))},onUpdate:function(a){if(!a.id)throw"PonyExpress Items need id";var b=this.collection.find(function(b){return b.get("id")===a.id});b&&(b.set(a),this.dispatch("update",a))}}});